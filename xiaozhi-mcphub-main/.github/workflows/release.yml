name: GitHub Release

on:
  push:
    tags: ['v*.*.*']

permissions:
  contents: write

jobs:
  wait-for-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Docker build to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'build'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success,failure,cancelled

  build-assets:
    runs-on: ubuntu-latest
    needs: wait-for-docker
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Create distribution package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_DIR="xiaozhi-mcphub-v$VERSION"
          mkdir -p "$PACKAGE_DIR"
          
          # å¤åˆ¶æ„å»ºäº§ç‰©
          cp -r dist "$PACKAGE_DIR/"
          cp -r frontend/dist "$PACKAGE_DIR/frontend-dist"
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp package.json pnpm-lock.yaml "$PACKAGE_DIR/"
          cp README.md README.zh.md LICENSE "$PACKAGE_DIR/"
          cp docker-compose.yml Dockerfile entrypoint.sh "$PACKAGE_DIR/"
          cp nginx.conf.example servers.json "$PACKAGE_DIR/"
          
          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > "$PACKAGE_DIR/install.sh" << 'EOF'
          #!/bin/bash
          echo "å°æ™º MCP Hub v$VERSION å®‰è£…è„šæœ¬"
          echo "è¯·ç¡®ä¿å·²å®‰è£… Node.js 20+ å’Œ pnpm"
          echo ""
          echo "1. å®‰è£…ä¾èµ–: pnpm install --prod"
          echo "2. å¯åŠ¨æœåŠ¡: pnpm start"
          echo "3. æˆ–ä½¿ç”¨ Docker: docker-compose up -d"
          EOF
          chmod +x "$PACKAGE_DIR/install.sh"
          
          # æ‰“åŒ…ï¼ˆä¿æŒç›®å½•ç»“æ„ï¼‰
          tar -czf xiaozhi-mcphub-v$VERSION.tar.gz "$PACKAGE_DIR"
          zip -r xiaozhi-mcphub-v$VERSION.zip "$PACKAGE_DIR"

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          if [ -n "$PREV_TAG" ]; then
            echo "## ğŸš€ What's Changed" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" $PREV_TAG..HEAD >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          else
            echo "## ğŸš€ Initial Release" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "å°æ™º MCP Hub é¦–æ¬¡å‘å¸ƒï¼" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # æ·»åŠ  Docker é•œåƒä¿¡æ¯
          echo "## ğŸ³ Docker Images" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- **Baseç‰ˆæœ¬**: \`huangjunsen/xiaozhi-mcphub:$VERSION\`" >> CHANGELOG.md
          echo "- **Latestç‰ˆæœ¬**: \`huangjunsen/xiaozhi-mcphub:latest\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "æ”¯æŒæ¶æ„: \`linux/amd64\`, \`linux/arm64\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # æ·»åŠ å¿«é€Ÿå¼€å§‹
          echo "## ğŸš€ Quick Start" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "\`\`\`bash" >> CHANGELOG.md
          echo "# Docker Compose æ–¹å¼ï¼ˆæ¨èï¼‰" >> CHANGELOG.md
          echo "wget https://github.com/${{ github.repository }}/releases/download/v$VERSION/xiaozhi-mcphub-v$VERSION.tar.gz" >> CHANGELOG.md
          echo "tar -xzf xiaozhi-mcphub-v$VERSION.tar.gz" >> CHANGELOG.md
          echo "cd xiaozhi-mcphub-v$VERSION" >> CHANGELOG.md
          echo "docker compose up -d" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "# æˆ–æ‰‹åŠ¨å®‰è£…éƒ¨ç½²" >> CHANGELOG.md
          echo "./install.sh" >> CHANGELOG.md
          echo "\`\`\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # å°†å†…å®¹ä¿å­˜åˆ°è¾“å‡º
          {
            echo 'CHANGELOG<<EOF'
            cat CHANGELOG.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ github.ref_name }}"
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            xiaozhi-mcphub-v*.tar.gz
            xiaozhi-mcphub-v*.zip
          generate_release_notes: false